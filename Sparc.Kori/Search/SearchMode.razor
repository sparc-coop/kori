@* <aside id="kori-search" class="@(Kori.Mode == "Search" ? "show" : "")">
    <header>
        <div>
            <h5>Navigation</h5>
            <button onclick="@Kori.CloseAsync">
                <CloseIcon />
            </button>
        </div>
    </header>

    <BetterSearch IsLoading="@IsLoading" Placeholder="Type to find..." TItem="SearchContentResponse" OnSearch="SearchAsync">
        <ItemTemplate>
            @foreach (var messagesByRoom in messageResults.GroupBy(x => x.MessageRoomId))
            {
                var roomId = messagesByRoom.Key;
                var roomName = messagesByRoom.First().MessageRoomName;
                <article>
                    <div onclick="@(() => GoRoom(roomId))">
                        <PageIcon />
                        <span>@roomName</span>
                    </div>

                    @foreach (var message in messagesByRoom)
                    {
                        <div onclick="@(() => Go(message))">
                            <ContentIcon />
                            <span>@(message.MessageText ?? message.MessageTag)</span>
                        </div>
                    }
                </article>
            }
        </ItemTemplate>
    </BetterSearch>
</aside>

@code {
    bool IsLoading;
    List<SearchContentResponse> messageResults = new();
    string searchTerm = "";

    async Task<IEnumerable<SearchContentResponse>> SearchAsync(string? searchTerm)
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            return Array.Empty<SearchContentResponse>();
        }

        IsLoading = true;
        var result = await Kori.SearchContentAsync(searchTerm);
        messageResults = result;
        IsLoading = false;

        return messageResults;
    }       

    async Task Go(SearchContentResponse selectedItem)
    {
        string baseUrl = selectedItem.MessageRoomName.StartsWith("http")
            ? selectedItem.MessageRoomName
            : $"https://{selectedItem.MessageRoomName}";

        string messageText = selectedItem.MessageText ?? selectedItem.MessageTag ?? "";

        string encodedTextFragment = Uri.EscapeDataString(messageText);

        var fullUrl = $"{baseUrl}#:~:text={encodedTextFragment}";

        Nav.NavigateTo(fullUrl, forceLoad: true);
    }

    async Task GoRoom(string roomId)
    {
        var roomName = messageResults.FirstOrDefault(m => m.MessageRoomId == roomId)?.MessageRoomName;

        var fullUrl = roomName.StartsWith("http")
            ? roomName
            : $"https://{roomName}";

        Nav.NavigateTo(fullUrl, forceLoad: true);
    }
} *@




<aside id="kori-search" class="@(Kori.Mode == "Search" ? "show" : "")">
    <header>
        <div>
            <h5>Navigation</h5>
            <button onclick="@Kori.CloseAsync">
                <CloseIcon />
            </button>
        </div>
    </header>

    <BetterSearch IsLoading="@IsLoading" Placeholder="Type to find..." TItem="KoriSearch" OnSearch="SearchAsync">
        <ItemTemplate>
            @foreach (var contentsByDomain in contentResults.GroupBy(x => x.Domain))
            {
                var domain = contentsByDomain.Key;
                <article>
                    <div onclick="@(() => GoDomain(domain, null))">
                        <PageIcon />
                        <span>@domain</span>
                    </div>

                    @foreach (var content in contentsByDomain)
                    {
                        <div onclick="@(() => Go(content))">
                            <ContentIcon />
                            <span>@(content.Text ?? content.Tag)</span>
                        </div>
                    }
                </article>
            }
        </ItemTemplate>
    </BetterSearch>
</aside>

@code {
    bool IsLoading;
    List<KoriSearch> contentResults = new();
    string searchTerm = "";

    async Task<IEnumerable<KoriSearch>> SearchAsync(string? searchTerm)
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            return Array.Empty<KoriSearch>();
        }

        IsLoading = true;

        contentResults = await Kori.SearchAsync(searchTerm);
        IsLoading = false;

        return contentResults;
    }   

    async Task Go(KoriSearch selectedContent)
    {
        string baseUrl = selectedContent.Domain.StartsWith("http")
            ? selectedContent.Domain
            : $"https://{selectedContent.Domain}";

        string fullUrl = $"{baseUrl}{(string.IsNullOrWhiteSpace(selectedContent.Path) ? "" : selectedContent.Path)}";

        string encodedTextFragment = Uri.EscapeDataString(selectedContent.Text ?? selectedContent.Tag ?? "");

        fullUrl = $"{fullUrl}#:~:text={encodedTextFragment}";

        Nav.NavigateTo(fullUrl, forceLoad: true);
    }

    async Task GoDomain(string domain, string? path)
    {
        string baseUrl = domain.StartsWith("http")
            ? domain
            : $"https://{domain}";

        string fullUrl = $"{baseUrl}{(string.IsNullOrWhiteSpace(path) ? "" : path)}";

        Nav.NavigateTo(fullUrl, forceLoad: true);
    }
}